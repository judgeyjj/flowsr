# FlowSR (FlowHigh) 训练 / 推理配置
# - `train.py` 会把该 YAML 归一化成 FlowHighTrainer 所需字段
# - `inference.py` 仅读取 `inference:` 下的配置

seed: 104

model:
  modelname: "FLowHigh-DiM"
  architecture: "mamba2"  # mamba / mamba2 / transformer / convnext

  # FlowHigh backbone
  dim: 1024
  n_layers: 2
  n_heads: 16
  dim_head: 64

  # CFM / ODE
  cfm_path: "independent_cfm_adaptive"
  sigma: 1e-4

  # Vocoder（训练端默认不在初始化时加载；仅在 decode 保存音频时才需要）
  vocoder: "bigvgan"
  vocoderpath: "vocoder/BIGVGAN/checkpoint/g_48_00850000"
  vocoderconfigpath: "vocoder/BIGVGAN/config/bigvgan_48khz_256band_config.json"

  # Mamba / Mamba2 推荐配置
  # - Mamba2 建议 d_state=128 + headdim=64
  mamba_d_state: 128
  mamba_d_conv: 4
  mamba_expand: 2
  mamba2_headdim: 64

data:
  train_dir: "/data01/audio_group/m24_yuanjiajun/AP-BWE/VCTK-Corpus-0.92/wav_test/train/clean"
  val_dir: "/data01/audio_group/m24_yuanjiajun/AP-BWE/VCTK-Corpus-0.92/wav_test/train/eval"
  valid_prepare: true

  # 采样率（训练时会随机从 source_sr_list 生成 LR 条件，再上采样到 target_sr）
  target_sr: 48000
  # 对齐 FlowHigh：使用区间随机（step=1000），不使用离散列表
  downsample_min: 4000
  downsample_max: 32000
  downsampling_method: "scipy"  # scipy / librosa / torchaudio

  # Mel/STFT 参数（用于 MelVoco encode）
  n_mel_channels: 256
  mel_fmin: 20
  mel_fmax: 24000
  n_fft: 2048
  win_length: 2048
  hop_length: 480

  # Training data
  batch_size: 128  # Aligned with FlowHigh config.json (was 2)
  num_workers: 4

optimizer:
  lr: 3e-4         # Aligned with FlowHigh config.json (was 1e-4)

training:
  # 对齐 FlowHigh：显式按 step 训练（train.py 会优先使用 n_train_steps）
  n_train_steps: 400001
  n_warmup_steps: 0
  initial_lr: 1e-5
  log_every: 10000
  save_results_every: 10000
  save_model_every: 100000
  random_split_seed: 53
  weighted_loss: false
  ddp_find_unused_parameters: true

output:
  exp_dir: "./experiments"
  exp_name: "dmrf_sr_spectrum_unet"  # mamba2 会自动追加后缀，避免覆盖旧 ckpt
  use_swanlab: true
  swanlab_project: "dmrf-sr"
  swanlab_log_interval_steps: 1

inference:
  checkpoint: "/data01/audio_group/m24_yuanjiajun/flowsr/experiments/dmrf_sr_spectrum_unet/FLowHigh.300000.pt"
  input_path: "/data01/audio_group/m24_yuanjiajun/AP-BWE/VCTK-Corpus-0.92/wav_test/test/clean"
  output_path: "./output_207"
  gt_path: "/data01/audio_group/m24_yuanjiajun/AP-BWE/VCTK-Corpus-0.92/wav_test/test/clean"

  device: "cuda"

  target_sampling_rate: 48000
  simulate_low_sr: 16000
  up_sampling_method: "scipy"

  architecture: "mamba2"  # mamba / mamba2 / transformer / convnext
  time_step: 1
  cfm_method: "independent_cfm_adaptive"
  ode_method: "euler"
  sigma: 1e-4

  n_layers: 2
  n_heads: 16
  dim_head: 64
  dim: 1024

  n_mels: 256
  f_max: 24000
  n_fft: 2048
  win_length: 2048
  hop_length: 480

  vocoder: "bigvgan"
  vocoder_path: "/data01/audio_group/m24_yuanjiajun/flowsr/vocoder/BIGVGAN/checkpoint/g_48_00850000"
  vocoder_config_path: "/data01/audio_group/m24_yuanjiajun/flowsr/vocoder/BIGVGAN/config/bigvgan_48khz_256band_config.json"

  chunk_seconds: null
  compute_metrics: true
